testapp:
  build:
    context: .
    dockerfile: Dockerfile
  environment:
    AUTH_COOKIE_NAME: _proxy
    AUTH_TOKEN_SECRET: Rm9yIEdvZCBzbyBsb3ZlZCB0aGUgd29ybGQgdGhhdCBoZSBnYXZlIGhpcyBvbmUgYW5kIG9ubHkgU29uLCB0aGF0IHdob2V2ZXIgYmVsaWV2ZXMgaW4gaGltIHNoYWxsIG5vdCBwZXJpc2ggYnV0IGhhdmUgZXRlcm5hbCBsaWZlLiAtIEpvaG4gMzoxNg==
    AUTH_SITES: one:server1:80;two:server2:80;three:server3:80
    MANAGEMENT_API: fakemanagementapi:80/some/path
  volumes:
    - ./Caddyfile:/etc/caddy/Caddyfile
  command: caddy run

test:
  image: golang:1.18
  environment:
    AUTH_COOKIE_NAME: _proxy
    AUTH_TOKEN_SECRET: Rm9yIEdvZCBzbyBsb3ZlZCB0aGUgd29ybGQgdGhhdCBoZSBnYXZlIGhpcyBvbmUgYW5kIG9ubHkgU29uLCB0aGF0IHdob2V2ZXIgYmVsaWV2ZXMgaW4gaGltIHNoYWxsIG5vdCBwZXJpc2ggYnV0IGhhdmUgZXRlcm5hbCBsaWZlLiAtIEpvaG4gMzoxNg==
    AUTH_SITES: one:server1:80;two:server2:80;three:server3:80
    MANAGEMENT_API: fakemanagementapi:80/some/path
  volumes:
    - .:/src
  working_dir: /src
  depends_on:
    - testapp
    - fakemanagementapi
    - server1
    - server2
    - server3

fakemanagementapi:
  image: caddy:latest
  environment:
    RESPONSE: API
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server1:
  image: caddy:latest
  environment:
    RESPONSE: 1
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server2:
  image: caddy:latest
  environment:
    RESPONSE: 2
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server3:
  image: caddy:latest
  environment:
    RESPONSE: 3
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run
