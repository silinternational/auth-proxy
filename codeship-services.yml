testapp:
  build:
    context: .
    dockerfile: Dockerfile
  cached: true
  default_cache_branch: "develop"
  env_file: test.env
  command: caddy run

test:
  image: golang:1.18
  env_file: test.env
  volumes:
    - .:/src
  working_dir: /src
  depends_on:
    - testapp
    - fakemanagementapi
    - server1
    - server2
    - server3

fakemanagementapi:
  image: caddy:latest
  environment:
    SERVER: API
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server1:
  image: caddy:latest
  environment:
    SERVER: server1
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server2:
  image: caddy:latest
  environment:
    SERVER: server2
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server3:
  image: caddy:latest
  environment:
    SERVER: server3
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run
