testapp:
  build:
    context: .
    dockerfile: Dockerfile
  environment:
    COOKIE_NAME: _proxy
    TOKEN_SECRET: Rm9yIEdvZCBzbyBsb3ZlZCB0aGUgd29ybGQgdGhhdCBoZSBnYXZlIGhpcyBvbmUgYW5kIG9ubHkgU29uLCB0aGF0IHdob2V2ZXIgYmVsaWV2ZXMgaW4gaGltIHNoYWxsIG5vdCBwZXJpc2ggYnV0IGhhdmUgZXRlcm5hbCBsaWZlLiAtIEpvaG4gMzoxNg==
    SITES: one:server1:80,two:server2:80,three:server3:80
    MANAGEMENT_API: https://fakemanagementapi:80/api
  volumes:
    - ./Caddyfile:/etc/caddy/Caddyfile
  command: caddy run

test:
  image: golang:1.18
  environment:
    COOKIE_NAME: _proxy
    TOKEN_SECRET: Rm9yIEdvZCBzbyBsb3ZlZCB0aGUgd29ybGQgdGhhdCBoZSBnYXZlIGhpcyBvbmUgYW5kIG9ubHkgU29uLCB0aGF0IHdob2V2ZXIgYmVsaWV2ZXMgaW4gaGltIHNoYWxsIG5vdCBwZXJpc2ggYnV0IGhhdmUgZXRlcm5hbCBsaWZlLiAtIEpvaG4gMzoxNg==
    SITES: one:server1:80,two:server2:80,three:server3:80
    MANAGEMENT_API: https://fakemanagementapi:80/api
  volumes:
    - .:/src
  working_dir: /src
  depends_on:
    - testapp
    - fakemanagementapi
    - server1
    - server2
    - server3

fakemanagementapi:
  image: caddy:latest
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server1:
  image: caddy:latest
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server2:
  image: caddy:latest
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run

server3:
  image: caddy:latest
  volumes:
    - ./Caddyfile-test:/srv/Caddyfile
  command: caddy run
